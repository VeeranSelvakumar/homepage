<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Veeran Tech Point</title>

<style>
body { 
  font-family: Arial; 
  background-color: #f9fafb; 
  background-image: 
    linear-gradient(to right, #e5e7eb 1px, transparent 1px),
    linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
  background-size: 20px 20px;
  padding:20px; 
}
.container{
  max-width:600px;
  margin:auto;
  background:transparent;
  padding:20px;
}
h1{ color:#1a73e8; text-align:center; }
p{ text-align:center; color:#555; }
label{ font-weight:bold; display:block; margin-top:12px; }
input, select{
  width:100%;
  padding:12px;
  margin-top:6px;
  border:1px solid #ccc;
  border-radius:6px;
  font-size:15px;
}
button{
  margin-top:20px;
  width:100%;
  padding:14px;
  font-size:18px;
  background:#1a73e8;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
button:hover{ background:#0b5ed7; }
#error{ color:red; display:none; margin-top:10px; text-align:center; }
#loading{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
  color:white;
  font-size:22px;
}
.qr-box{
  display:flex;
  justify-content:center;
  align-items:center;
  margin:25px 0;
}

#qrImage{
  width:260px;
  height:260px;
  display:none;
  margin:20px auto;   /* ‚≠ê MAIN FIX */
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
  background:white;
  padding:8px;
}
.reset-btn{
  margin-top:15px;
  width:100%;
  padding:14px;
  font-size:16px;
  background:#dc3545;   /* Bootstrap red */
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.reset-btn:hover{
  background:#b02a37;   /* Dark red on hover */
}
</style>
</head>

<body>

<div class="container">

  <!-- PAYMENT PAGE -->
  <div id="paymentPage" style="display:none;text-align:center;">
    <h2>Payment Required</h2>
    <p>Please scan QR or click Pay Now</p>

    <div class="qr-box">
      <img id="qrImage">
    </div>
    <p style="font-size:13px;color:#666;">Desktop users: Please scan QR using your mobile UPI app</p>

    <a id="upiBtn" href="#"><button style="background:green;">Pay</button></a>
    <br><br>
    <a href="voterpreview.html" target="_blank">
      <button style="background:#ffc107; color:#000; margin-top:0px;">
        Preview Voter ID (No Extra Fee)
      </button>
    </a>

    <button onclick="showPaidPage()">I have paid</button>
    <button class="reset-btn" onclick="confirmReset()">
      Reset Application
    </button>
  </div>

  <!-- PAID CONFIRM PAGE -->
  <div id="paidPage" style="display:none;text-align:center;">
    <p>
      Payment Status :
      <span id="paidBadge" style="padding:6px 10px;border-radius:6px;background:#dc3545;color:#fff;">
        NOT PAID
      </span>
    </p>

    <h2>Payment Confirmation</h2>
    <p>Please enter UPI Reference Number</p>
    <input   type="text"
  id="upiRef"
  name="upiRef"
  placeholder="Enter 12 digit UPI Ref"
  maxlength="12"
  inputmode="numeric"
  pattern="[0-9]{12}"
  required
  oninput="this.value = this.value.replace(/[^0-9]/g, '')">
    <br><br>
    <button onclick="if(validateUpiRef()) finalConfirm(event)">
  Confirm Payment
</button>

  </div>

  <h1 id="pageTitle"></h1>
  <p id="pageDesc"></p>
  <form id="dynamicForm"></form>
  <div id="error">Please fill all required fields</div>

</div>

<div id="loading">Submitting‚Ä¶ Please wait</div>

<script>
const PAYMENT_AMOUNT = 1;
let APPLICATION_ID = localStorage.getItem("APPLICATION_ID");
</script>


<script>


const SERVICE_CONFIG = {
  serviceKey : "New Voter ID Card",

  title : "New Voter ID Application",
  description : "Apply for New Voter ID easily",

  fields : [
    { id:"tamname", label:"‡ÆÆ‡ØÅ‡Æ¥‡ØÅ‡Æ™‡Øç‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Æø‡Æ≤‡Øç)", type:"text", required:true },
    { id:"name", label:"Full Name (English)", type:"text", required:true },
    { id:"mobile", label:"Mobile Number", type:"tel", required:true, max:10 },
    { id:"fathertamname", label:"‡Æ§‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æø‡Æ©‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Æø‡Æ≤‡Øç)", type:"text", required:true },
    { id:"fatherengname", label:"Father's Name (English)", type:"text", required:true },
    { id:"gender", label:"‡Æ™‡Ææ‡Æ≤‡Æø‡Æ©‡ÆÆ‡Øç/Gender", type:"select", required:true,
      options:["‡ÆÜ‡Æ£‡Øç/Male","‡Æ™‡ØÜ‡Æ£‡Øç/Female","‡ÆÆ‡Æ±‡Øç‡Æ±‡Æµ‡Øà/Other"]
    },
    { id:"tamaddress", label:"‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Æø‡Æ≤‡Øç)", type:"text", required:true },
    { id:"engaddress", label:"Address (English)", type:"text", required:true },
    { id:"dob", label:"Date of Birth", type:"date", required:true }
  ],

  files : [
    { id:"aadhaarfrontBase64", label:"Aadhaar Card Front Page", required:false },
    { id:"aadhaarbackBase64", label:"Aadhaar Card Back Page", required:false },
    { id:"photoBase64", label:"Photo", required:false }
  ]
};
</script>


<script>
document.getElementById("pageTitle").innerText = SERVICE_CONFIG.title;
document.getElementById("pageDesc").innerText  = SERVICE_CONFIG.description;

const form = document.getElementById("dynamicForm");

/* Fields */
SERVICE_CONFIG.fields.forEach(f=>{
  let html = `<label>${f.label}${f.required?" *":""}</label>`;
  if(f.type==="select"){
    html+=`<select name="${f.id}" ${f.required?"required":""}>
      <option value="">-- Select --</option>
      ${f.options.map(o=>`<option>${o}</option>`).join("")}
    </select>`;
  }else{
    let extra = "";

  // Aadhaar number ‚Äì 12 digit only
  if(f.id === "aadhaarnumber"){
    extra = `
      inputmode="numeric"
      maxlength="12"
      onkeypress="return event.charCode >= 48 && event.charCode <= 57"
      oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,12)"
      placeholder="12 digit Aadhaar"
    `;
  }

  // Mobile ‚Äì existing logic
  if(f.type === "tel"){
    extra = `
      inputmode="numeric"
      maxlength="10"
      oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10)"
    `;
  }

  html+=`<input 
    type="${f.type}" 
    name="${f.id}" 
    ${f.required?"required":""}
    ${extra}
  >`;
  }
  form.insertAdjacentHTML("beforeend", html);
});

/* Files */
SERVICE_CONFIG.files.forEach(f=>{
  form.insertAdjacentHTML("beforeend",
    `<label>${f.label}${f.required?" *":""}</label>
     <input type="file" data-id="${f.id}" ${f.required?"required":""}>`
  );
});

form.insertAdjacentHTML("beforeend", `<button type="submit">Submit Application</button>`);

/* UPI */
document.getElementById("upiBtn").href =
`upi://pay?pa=rselvakumar906@okaxis&pn=Selvakumar&am=${PAYMENT_AMOUNT}&cu=INR`;
document.querySelector("#upiBtn button").innerText = `Pay ‚Çπ${PAYMENT_AMOUNT} Now`;

/* Payment page restore */


function showPaymentPage(){
  form.style.display="none";
  pageTitle.style.display="none";
  pageDesc.style.display="none";
  paymentPage.style.display="block";

  generateQR();   // üî• Auto generate
}
function showPaidPage(){
  paymentPage.style.display="none";
  paidPage.style.display="block";
}

/* Submit */
form.addEventListener("submit", async e=>{
  e.preventDefault();
  loading.style.display="flex";

  const fd = new FormData();
  fd.append("service", SERVICE_CONFIG.serviceKey);
  fd.append("config", JSON.stringify(SERVICE_CONFIG));

  for(const f of SERVICE_CONFIG.fields){
    fd.append(f.id, form.querySelector(`[name="${f.id}"]`).value);
  }

  const toBase64 = f => new Promise(r=>{
    const fr=new FileReader();
    fr.onload=()=>r(fr.result);
    fr.readAsDataURL(f);
  });

  for(const f of SERVICE_CONFIG.files){
    const input = form.querySelector(`input[data-id="${f.id}"]`);
    const file = input.files[0];

    if(file){
      if(f.id === "photoBase64" && file){
        const base64 = await toBase64(file);
        fd.append(f.id, base64);

        // Save photo for preview page
        localStorage.setItem("PREVIEW_PHOTO", base64);
      } else {
        fd.append(f.id, file ? await toBase64(file) : "");
      }
    } else {
      // if file not selected
      if(f.required){
        alert("Please upload: " + f.label);
        loading.style.display="none";
        return;
      }
      // if not required, just skip
      fd.append(f.id, "");
    }
  }

  fetch("https://script.google.com/macros/s/AKfycbxTB-uYmJedcd3MVHsLyYJ6wC6p6M_v66V8owddPEQvRF8n7a5XhWHDlID8vCkG753MKA/exec", { method:"POST", body:fd })
    .then(r=>r.json())
    .then(res=>{
      APPLICATION_ID = res.appId;
      localStorage.setItem("APPLICATION_ID", APPLICATION_ID);
      // Save form data for preview page
      const previewData = {};
      SERVICE_CONFIG.fields.forEach(f=>{
        previewData[f.id] = form.querySelector(`[name="${f.id}"]`).value;
      });

      localStorage.setItem("PREVIEW_DATA", JSON.stringify(previewData));
      alert("Application submitted. Please complete payment.");
      showPaymentPage();
    })
    .finally(()=> loading.style.display="none");
});

/* FINAL CONFIRM */
function finalConfirm(e){
  const btn = e.target;
  btn.disabled = true;

  const ref = upiRef.value.trim();
  if(!/^[0-9A-Za-z]{8,14}$/.test(ref)){
    alert("Invalid UPI reference");
    btn.disabled = false;
    return;
  }

  const fd = new FormData();
  fd.append("action", "confirmPayment");
  fd.append("appId", APPLICATION_ID);
  fd.append("upiRef", ref);
  fd.append("amount", PAYMENT_AMOUNT);

  fetch("https://script.google.com/macros/s/AKfycbxTB-uYmJedcd3MVHsLyYJ6wC6p6M_v66V8owddPEQvRF8n7a5XhWHDlID8vCkG753MKA/exec", { method:"POST", body:fd })
    .then(r => r.json())
    .then(res => {
      if(res.status === "SUCCESS"){
        paidBadge.innerText = "PAID";
        paidBadge.style.background = "#28a745";
        localStorage.removeItem("APPLICATION_ID");
        

        // Open WhatsApp links
        if (res.whatsappAdmin) {
          window.open(res.whatsappAdmin, "_blank");
        }
        // Redirect to certificates page
        location.href = "identity.html";
      } else {
        alert(res.message);
        btn.disabled = false;
      }
    })
    .catch(err=>{
      alert("Error confirming payment: " + err.message);
      btn.disabled = false;
    });
}
function validateUpiRef() {
  const upi = document.getElementById("upiRef").value;

  if (!/^\d{12}$/.test(upi)) {
    alert("Please enter valid 12 digit UPI Reference Number");
    return false;
  }
  return true;
}
function confirmReset(){
  const ok = confirm(
    "‚ö†Ô∏è This will clear your saved data.\n\nDo you want to start a new application?"
  );

  if(ok){
    localStorage.clear();   // browser saved data delete
    location.reload();     // fresh start
  }
}

function resetApplication(){
  localStorage.removeItem("APPLICATION_ID");
  location.reload();
}
</script>
<script>
const qrImage = document.getElementById("qrImage");
const upiBtn = document.getElementById("upiBtn");

function generateQR() {
  const gender = document.querySelector('[name="gender"]')?.value || "";

  const upiString = `upi://pay?pa=rselvakumar906@okaxis&pn=Selvakumar&am=${PAYMENT_AMOUNT}&cu=INR&note=${encodeURIComponent(gender)}`;

  // Generate QR via API
  const qrURL = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(upiString)}`;

  qrImage.src = qrURL;
  qrImage.style.display = "block";

  // Update pay button href
  upiBtn.href = upiString;
  upiBtn.querySelector("button").innerText = `Pay ‚Çπ${PAYMENT_AMOUNT} Now`;
}

// Attach listener after gender field is created
function attachGenderListener(){
  const genderSelect = document.querySelector('[name="gender"]');
  if(genderSelect){
    genderSelect.addEventListener("change", generateQR);

    // generate QR if value already selected
    if(genderSelect.value) generateQR();
  }
}

// Call after dynamic form is generated
attachGenderListener();

window.addEventListener("load", function(){

  const appId = localStorage.getItem("APPLICATION_ID");

  if(appId){
    showPaymentPage();
  }

});
</script>

</body>
</html>


