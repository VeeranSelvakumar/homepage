<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Veeran Tech Point</title>

<!-- ================= NEVER CHANGE STYLE ================= -->
<style>
body { 
  font-family: Arial; 
  background-color: #f9fafb; 
  background-image: 
    linear-gradient(to right, #e5e7eb 1px, transparent 1px),
    linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
  background-size: 20px 20px;
  padding:20px; 
}
.container{
  max-width:1500px;
  margin:auto;
  background:transparent;
  padding:20px;
}
h1{ color:#1a73e8; text-align:center; }
p{ text-align:center; color:#555; }
label{ font-weight:bold; display:block; margin-top:12px; }
input, select{
  width:100%;
  padding:12px;
  margin-top:6px;
  border:1px solid #ccc;
  border-radius:6px;
  font-size:15px;
}
button{
  margin-top:20px;
  width:100%;
  padding:14px;
  font-size:18px;
  background:#1a73e8;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
button:hover{ background:#0b5ed7; }
#error{ color:red; display:none; margin-top:10px; text-align:center; }
#loading{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
  color:white;
  font-size:22px;
}
table{ width:100%; border-collapse:collapse; margin-top:10px;}
table, th, td{ border:1px solid #ccc; padding:6px; text-align:center; }
td input, td select{ width:100%; box-sizing:border-box; }

.reset-btn{
  margin-top:15px;
  width:100%;
  padding:14px;
  font-size:16px;
  background:#dc3545;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.reset-btn:hover{ background:#b02a37; }
</style>
</head>

<body>

<div class="container">

<!-- ================= PAYMENT PAGE ================= -->
<div id="paymentPage" style="display:none;text-align:center;">
  <h2>Payment Required</h2>
  <p>Please scan QR or click Pay Now</p>

  <img src="GooglePay_QR.png" width="260" style="margin:20px 0;">
  <p style="font-size:13px;color:#666;">Desktop users: Scan QR using mobile UPI app</p>

  <a id="upiBtn" href="#"><button style="background:green;">Pay</button></a>
  <br><br>
  <button onclick="showPaidPage()">I have paid</button>
  <button class="reset-btn" onclick="confirmReset()">
      Reset Application
  </button>
</div>

<!-- ================= PAID CONFIRM PAGE ================= -->
<div id="paidPage" style="display:none;text-align:center;">
  <p>
    Payment Status :
    <span id="paidBadge" style="padding:6px 10px;border-radius:6px;background:#dc3545;color:#fff;">
      NOT PAID
    </span>
  </p>

  <h2>Payment Confirmation</h2>
  <p>Please enter UPI Reference Number</p>

  <input type="text" id="upiRef" maxlength="12"
    placeholder="Enter 12 digit UPI Ref"
    inputmode="numeric"
    oninput="this.value=this.value.replace(/[^0-9]/g,'')">

  <br><br>
  <button onclick="if(validateUpiRef()) finalConfirm(event)">Confirm Payment</button>
</div>

<!-- ================= APPLICATION FORM ================= -->
<h1 id="pageTitle"></h1>
<p id="pageDesc"></p>

<form id="dynamicForm"></form>
<div id="error">Please fill all required fields</div>

</div>

<div id="loading">Submitting… Please wait</div>

<script>
const PAYMENT_AMOUNT = 60;
let APPLICATION_ID = localStorage.getItem("APPLICATION_ID");
</script>

<!-- ===================== ONLY CHANGE BELOW ===================== -->
<script>
const SERVICE_CONFIG = {
  serviceKey : "First Graduate Certificate",

  title : "First Graduate Certificate Application",
  description : "Apply for First Graduate Certificate easily",

  fields : [
    { id:"name", label:"Full Name", type:"text", required:true },
    { id:"mobile", label:"Mobile Number", type:"tel", required:true, max:10 },
    { id:"institutionAddress", label:"Institution Address", type:"text", required:true },
    { id:"courseCompleted", label:"Candidate Course Completed", type:"select", required:true,
      options:["SSLC","Higher Secondary","Diploma","Graduate"]
    },
    {
      id:"familyTable",
      type:"familyTable",
      rows:[
        "தந்தை","தாய்","மூத்த அண்ணன்","மூத்த சகோதரி",
        "தந்தையின் தந்தை","தந்தையின் தாய்",
        "தாயின் தந்தை","தாயின் தாய்"
      ]
    }
  ],

  files : [
    { id:"photoBase64", label:"Applicant Photo", required:true },
    { id:"aadhaarFrontBase64", label:"Aadhaar Front", required:true },
    { id:"aadhaarBackBase64", label:"Aadhaar Back", required:true },
    { id:"rationFrontBase64", label:"Ration Card Front", required:true },
    { id:"rationBackBase64", label:"Ration Card Back", required:true },
    { id:"coursecertificateBase64", label:"Course Certificate", required:true },
    { id:"signatureBase64", label:"Signature", required:true }
  ]
};
</script>
<!-- ===================== STOP EDIT ===================== -->

<script>
document.getElementById("pageTitle").innerText = SERVICE_CONFIG.title;
document.getElementById("pageDesc").innerText  = SERVICE_CONFIG.description;

const form = document.getElementById("dynamicForm");

/* Build form – ORIGINAL LOGIC UNTOUCHED */
SERVICE_CONFIG.fields.forEach(f=>{
  if(f.type==="familyTable"){
    let html=`<label>Family Details</label><table><tr>
      <th>Relation</th><th>Name</th><th>Age</th>
      <th>Qualification</th><th>Alive</th><th>Document</th>
    </tr>`;
    f.rows.forEach(r=>{
      html+=`<tr>
        <td><input value="${r}" readonly></td>
        <td><input></td>
        <td><input type="number"></td>
        <td><select>
          <option></option><option>10th</option><option>12th</option>
          <option>Diploma</option><option>Degree</option>
          <option>PG</option><option>Dropout</option><option>Non Literate</option>
        </select></td>
        <td><select><option></option><option>Yes</option><option>No</option></select></td>
        <td><input type="file"></td>
      </tr>`;
    });
    html+=`</table>`;
    form.insertAdjacentHTML("beforeend",html);
    return;
  }

  let html=`<label>${f.label} *</label>`;
  if(f.type==="select"){
    html+=`<select name="${f.id}" required>
      <option value="">-- Select --</option>
      ${f.options.map(o=>`<option>${o}</option>`).join("")}
    </select>`;
  }else{
    html+=`<input type="${f.type}" name="${f.id}" required>`;
  }
  form.insertAdjacentHTML("beforeend",html);
});

SERVICE_CONFIG.files.forEach(f=>{
  form.insertAdjacentHTML("beforeend",
    `<label>${f.label} *</label><input type="file" data-id="${f.id}" required>`
  );
});

form.insertAdjacentHTML("beforeend",`<button type="submit">Submit Application</button>`);

/* UPI */
upiBtn.href=`upi://pay?pa=rselvakumar906@okaxis&pn=Selvakumar&am=${PAYMENT_AMOUNT}&cu=INR`;
upiBtn.querySelector("button").innerText=`Pay ₹${PAYMENT_AMOUNT} Now`;

/* Restore payment */
if(APPLICATION_ID) showPaymentPage();

function showPaymentPage(){
  form.style.display="none";
  pageTitle.style.display="none";
  pageDesc.style.display="none";
  paymentPage.style.display="block";
}
function showPaidPage(){
  paymentPage.style.display="none";
  paidPage.style.display="block";
}

/* Submit application */
form.addEventListener("submit",async e=>{
  e.preventDefault();
  loading.style.display="flex";

  const fd=new FormData();
  fd.append("service",SERVICE_CONFIG.serviceKey);
  fd.append("config",JSON.stringify(SERVICE_CONFIG));

  SERVICE_CONFIG.fields.forEach(f=>{
    if(f.type!=="familyTable"){
      fd.append(f.id,form.querySelector(`[name="${f.id}"]`).value);
    }
  });

  const toBase64=f=>new Promise(r=>{
    const fr=new FileReader();
    fr.onload=()=>r(fr.result);
    fr.readAsDataURL(f);
  });

  for(const f of SERVICE_CONFIG.files){
    fd.append(f.id,await toBase64(form.querySelector(`[data-id="${f.id}"]`).files[0]));
  }

  const familyData = await collectFamilyTable();
  fd.append("familyTable",JSON.stringify(familyData));

  fetch("https://script.google.com/macros/s/AKfycbxTB-uYmJedcd3MVHsLyYJ6wC6p6M_v66V8owddPEQvRF8n7a5XhWHDlID8vCkG753MKA/exec",
    {method:"POST",body:fd})
  .then(r=>r.json())
  .then(res=>{
    APPLICATION_ID=res.appId;
    localStorage.setItem("APPLICATION_ID",APPLICATION_ID);
    alert("Application submitted. Please complete payment.");
    showPaymentPage();
  })
  .finally(()=>loading.style.display="none");
});

/* Family table */
function collectFamilyTable(){
  const rows=document.querySelectorAll("table tr");
  return Promise.all([...rows].slice(1).map(async r=>{
    const i=r.querySelectorAll("input,select");
    return {
      col1:i[0].value,
      col2:i[1].value,
      col3:i[2].value,
      col4:i[3].value,
      col5:i[4].value,
      col6:i[5].files[0]?.name||"",
      col6Base64:i[5].files[0]?await new Promise(res=>{
        const fr=new FileReader();
        fr.onload=()=>res(fr.result);
        fr.readAsDataURL(i[5].files[0]);
      }):""
    };
  }));
}

/* Payment confirm */
function finalConfirm(e){
  const btn=e.target;
  btn.disabled=true;

  const fd=new FormData();
  fd.append("action","confirmPayment");
  fd.append("appId",APPLICATION_ID);
  fd.append("upiRef",upiRef.value);
  fd.append("amount",PAYMENT_AMOUNT);

  fetch("https://script.google.com/macros/s/AKfycbxTB-uYmJedcd3MVHsLyYJ6wC6p6M_v66V8owddPEQvRF8n7a5XhWHDlID8vCkG753MKA/exec",
    {method:"POST",body:fd})
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="SUCCESS"){
      paidBadge.innerText="PAID";
      paidBadge.style.background="#28a745";
      localStorage.removeItem("APPLICATION_ID");

      // Open WhatsApp links
      if (res.whatsappAdmin) {
        window.open(res.whatsappAdmin, "_blank");
        }
      // Redirect to certificates page
      location.href="tn-certificates.html";
    }else{
      alert(res.message);
      btn.disabled=false;
    }
  })
  .catch(err=>{
      alert("Error confirming payment: " + err.message);
      btn.disabled = false;
  });
}

function validateUpiRef(){
  if(!/^\d{12}$/.test(upiRef.value)){
    alert("Enter valid 12 digit UPI reference");
    return false;
  }
  return true;
}

function confirmReset(){
  const ok = confirm(
    "⚠️ This will clear your saved data.\n\nDo you want to start a new application?"
  );

  if(ok){
    localStorage.clear();   // browser saved data delete
    location.reload();     // fresh start
  }
}

function resetApplication(){
  localStorage.removeItem("APPLICATION_ID");
  location.reload();
}
</script>

</body>
</html>
